# å›ºä»¶æ„å»ºå’ŒåŠ å¯†ä¸Šä¼ æµ‹è¯•æŒ‡å—

## æµ‹è¯•è„šæœ¬

ä½¿ç”¨ `scripts/test_remote_firmware_build.py` æµ‹è¯•å®Œæ•´çš„å›ºä»¶æ„å»ºæµç¨‹ã€‚

### åŠŸèƒ½

è¯¥è„šæœ¬æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š
1. âœ… **ç”¨æˆ·è®¤è¯** - ç™»å½•è·å–token
2. âœ… **è®¾å¤‡ç®¡ç†** - æ£€æŸ¥/åˆ›å»ºæµ‹è¯•è®¾å¤‡
3. âœ… **æ¨¡æ¿è·å–** - ä»æ•°æ®åº“è·å–å›ºä»¶æ¨¡æ¿
4. âœ… **è¿œç¨‹åº“å®‰è£…** - ä½¿ç”¨Arduino CLIè‡ªåŠ¨å®‰è£…æ‰€éœ€åº“
5. âœ… **å›ºä»¶ç¼–è¯‘** - ç¼–è¯‘.inoæ–‡ä»¶ä¸º.binæ–‡ä»¶
6. âœ… **å›ºä»¶åŠ å¯†** - ä½¿ç”¨XORæ©ç åŠ å¯†å›ºä»¶
7. âœ… **OTAæ¨é€** - å¯é€‰ï¼šæ¨é€OTAæ›´æ–°åˆ°è®¾å¤‡

### ä½¿ç”¨æ–¹æ³•

#### 1. åŸºæœ¬ä½¿ç”¨

```bash
cd /home/shigure/mqtt-tls-iot-guardian
python3 scripts/test_remote_firmware_build.py
```

#### 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

```bash
# è®¾ç½®APIåœ°å€
export API_BASE_URL=http://localhost:8000

# è®¾ç½®æµ‹è¯•ç”¨æˆ·
export TEST_USERNAME=admin
export TEST_PASSWORD=admin123

# è¿è¡Œæµ‹è¯•
python3 scripts/test_remote_firmware_build.py
```

#### 3. ä¿®æ”¹æµ‹è¯•è®¾å¤‡ID

ç¼–è¾‘è„šæœ¬ä¸­çš„é…ç½®ï¼š
```python
TEST_DEVICE_ID = "your-device-id"
TEST_WIFI_SSID = "your-wifi-ssid"
TEST_WIFI_PASSWORD = "your-wifi-password"
```

### æµ‹è¯•æµç¨‹

#### æ­¥éª¤1: ç™»å½•
- ä½¿ç”¨é…ç½®çš„ç”¨æˆ·åå¯†ç ç™»å½•
- è·å–JWT tokenç”¨äºåç»­APIè°ƒç”¨

#### æ­¥éª¤2: æ£€æŸ¥/åˆ›å»ºè®¾å¤‡
- æ£€æŸ¥æµ‹è¯•è®¾å¤‡æ˜¯å¦å­˜åœ¨
- å¦‚æœä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º

#### æ­¥éª¤3: è·å–æ¨¡æ¿
- ä»æ•°æ®åº“è·å–å¯ç”¨çš„ESP8266æ¨¡æ¿
- å¦‚æœæ‰¾åˆ°æ¨¡æ¿ï¼Œä½¿ç”¨æ¨¡æ¿IDï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤æ¨¡æ¿

#### æ­¥éª¤4: æ„å»ºåŠ å¯†å›ºä»¶

è¿™æ˜¯æ ¸å¿ƒæ­¥éª¤ï¼ŒåŒ…å«ï¼š

1. **ç”Ÿæˆå›ºä»¶ä»£ç **
   - ä»æ¨¡æ¿ç”Ÿæˆ.inoæ–‡ä»¶
   - æ›¿æ¢å ä½ç¬¦ï¼ˆè®¾å¤‡IDã€WiFié…ç½®ã€MQTTé…ç½®ã€CAè¯ä¹¦ç­‰ï¼‰

2. **è§£ææ‰€éœ€åº“**
   - ä»ä»£ç ä¸­è§£æ `#include` è¯­å¥
   - æå–åº“åç§°ï¼ˆå¦‚ï¼šPubSubClient, ArduinoJsonç­‰ï¼‰

3. **è¿œç¨‹åº“å®‰è£…**ï¼ˆå¦‚æœArduino CLIå¯ç”¨ï¼‰
   - æ£€æŸ¥åº“æ˜¯å¦å·²å®‰è£…
   - å¦‚æœæœªå®‰è£…ï¼Œä½¿ç”¨ `arduino-cli lib install` å®‰è£…
   - æ—¥å¿—ç¤ºä¾‹ï¼š
     ```
     [INFO] æ­£åœ¨å®‰è£…åº“: PubSubClient
     [INFO] åº“ PubSubClient å®‰è£…æˆåŠŸ
     ```

4. **ç¼–è¯‘å›ºä»¶**ï¼ˆå¦‚æœArduino CLIå¯ç”¨ï¼‰
   - ä½¿ç”¨ `arduino-cli compile` ç¼–è¯‘.inoæ–‡ä»¶
   - ç”Ÿæˆ.binæ–‡ä»¶
   - æ—¥å¿—ç¤ºä¾‹ï¼š
     ```
     [INFO] æ‰§è¡Œç¼–è¯‘å‘½ä»¤: arduino-cli compile --fqbn esp8266:esp8266:nodemcuv2 ...
     [INFO] å›ºä»¶ç¼–è¯‘æˆåŠŸ: firmware.bin
     ```

5. **åŠ å¯†å›ºä»¶**
   - ä½¿ç”¨XORæ©ç åŠ å¯†å›ºä»¶
   - ç”ŸæˆåŠ å¯†å¯†é’¥ï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼‰
   - è¾“å‡ºåŠ å¯†åçš„.binæ–‡ä»¶

#### æ­¥éª¤5: å¯é€‰ - OTAæ¨é€
- å¦‚æœæ„å»ºæˆåŠŸï¼Œå¯ä»¥æ¨é€OTAæ›´æ–°
- éœ€è¦è®¾å¤‡åœ¨çº¿æ‰èƒ½æ¥æ”¶æ›´æ–°

### é¢„æœŸè¾“å‡º

#### æˆåŠŸè¾“å‡ºç¤ºä¾‹

```
============================================================
è¿œç¨‹å›ºä»¶æ„å»ºå’ŒåŠ å¯†ä¸Šä¼ æµ‹è¯•
============================================================
APIåœ°å€: http://localhost:8000
æµ‹è¯•è®¾å¤‡: test-esp8266-001
============================================================

============================================================
1. ç™»å½•è·å–è®¤è¯token
============================================================
âœ… ç™»å½•æˆåŠŸ
   Token: eyJhbGciOiJIUzI1NiIs...

============================================================
2. æ£€æŸ¥/åˆ›å»ºè®¾å¤‡
============================================================
âœ… è®¾å¤‡å·²å­˜åœ¨: test-esp8266-001
   è®¾å¤‡ID: 01d5838b-f778-460d-a32c-11d5bb4816c1

============================================================
3. è·å–å›ºä»¶æ¨¡æ¿
============================================================
âœ… æ‰¾åˆ°æ¨¡æ¿: ESP8266-ILI9341 (ç‰ˆæœ¬: v1)
   æ¨¡æ¿ID: 96dc4271-9f2e-441d-baf1-5d0313488e1c

============================================================
4. æ„å»ºåŠ å¯†å›ºä»¶ï¼ˆåŒ…å«è¿œç¨‹åº“å®‰è£…ã€ç¼–è¯‘ã€åŠ å¯†ï¼‰
============================================================
ğŸ“¦ å¼€å§‹æ„å»ºå›ºä»¶...
   è®¾å¤‡ID: test-esp8266-001
   WiFi SSID: huawei9930
   MQTTæœåŠ¡å™¨: 10.42.0.1
   ä½¿ç”¨æ¨¡æ¿: 96dc4271-9f2e-441d-baf1-5d0313488e1c
   è¿œç¨‹åº“å®‰è£…: è‡ªåŠ¨
   ç¼–è¯‘: è‡ªåŠ¨
   åŠ å¯†: æ˜¯

âœ… å›ºä»¶æ„å»ºæˆåŠŸï¼
   çŠ¶æ€: completed
   å›ºä»¶ä»£ç : /path/to/test-esp8266-001.ino
   ç¼–è¯‘è¾“å‡º: /path/to/test-esp8266-001.bin
   åŠ å¯†å›ºä»¶: /path/to/test-esp8266-001_masked.bin

ğŸ“‹ æ„å»ºæ—¥å¿—æ‘˜è¦:
   [INFO] æ­£åœ¨å®‰è£…åº“: PubSubClient
   [INFO] åº“ PubSubClient å®‰è£…æˆåŠŸ
   [INFO] æ­£åœ¨å®‰è£…åº“: ArduinoJson
   [INFO] åº“ ArduinoJson å®‰è£…æˆåŠŸ
   [INFO] æ‰§è¡Œç¼–è¯‘å‘½ä»¤: arduino-cli compile ...
   [INFO] å›ºä»¶ç¼–è¯‘æˆåŠŸ

============================================================
âœ… æµ‹è¯•å®Œæˆï¼
============================================================
```

### ç”Ÿæˆçš„æ–‡ä»¶

æµ‹è¯•æˆåŠŸåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

1. **å›ºä»¶ä»£ç ** (`test-esp8266-001.ino`)
   - Arduinoæºä»£ç æ–‡ä»¶
   - åŒ…å«è®¾å¤‡é…ç½®ã€WiFié…ç½®ã€MQTTé…ç½®ã€CAè¯ä¹¦ç­‰

2. **ç¼–è¯‘è¾“å‡º** (`test-esp8266-001.bin`) - å¦‚æœç¼–è¯‘æˆåŠŸ
   - ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
   - å¯ç›´æ¥çƒ§å½•åˆ°ESP8266è®¾å¤‡

3. **åŠ å¯†å›ºä»¶** (`test-esp8266-001_masked.bin`)
   - ä½¿ç”¨XORæ©ç åŠ å¯†çš„å›ºä»¶
   - å¯ç”¨äºOTAæ›´æ–°æˆ–æ‰‹åŠ¨çƒ§å½•

### æ•…éšœæ’æŸ¥

#### é—®é¢˜1: ç¼–è¯‘è¾“å‡ºä¸ºNone

**ç—‡çŠ¶**ï¼š`ç¼–è¯‘è¾“å‡º: None`

**åŸå› **ï¼š
- Arduino CLIæœªå®‰è£…
- Arduino CLIæœªæ­£ç¡®é…ç½®
- ç¼–è¯‘å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥Arduino CLI
which arduino-cli
arduino-cli version

# å¦‚æœæœªå®‰è£…
sudo snap install arduino-cli

# åˆå§‹åŒ–Arduino CLI
arduino-cli config init
arduino-cli core update-index
arduino-cli core install esp8266:esp8266
```

#### é—®é¢˜2: åº“å®‰è£…å¤±è´¥

**ç—‡çŠ¶**ï¼šæ„å»ºæ—¥å¿—æ˜¾ç¤ºåº“å®‰è£…å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ‰‹åŠ¨å®‰è£…ç¼ºå¤±çš„åº“
arduino-cli lib install PubSubClient
arduino-cli lib install ArduinoJson
arduino-cli lib install Adafruit_GFX
arduino-cli lib install Adafruit_ILI9341

# éªŒè¯åº“å·²å®‰è£…
arduino-cli lib list
```

#### é—®é¢˜3: ç™»å½•å¤±è´¥

**ç—‡çŠ¶**ï¼š`âŒ ç™»å½•å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥APIåœ°å€æ˜¯å¦æ­£ç¡®

#### é—®é¢˜4: è®¾å¤‡åˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**ï¼š`âŒ åˆ›å»ºè®¾å¤‡å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- æ£€æŸ¥ç”¨æˆ·æƒé™
- æ£€æŸ¥è®¾å¤‡IDæ˜¯å¦å·²å­˜åœ¨

#### é—®é¢˜5: æ¨¡æ¿è·å–å¤±è´¥

**ç—‡çŠ¶**ï¼š`âš ï¸ æœªæ‰¾åˆ°å¯ç”¨æ¨¡æ¿`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ·»åŠ æ¨¡æ¿åˆ°æ•°æ®åº“
python3 scripts/add_template.py
```

### éªŒè¯æ„å»ºç»“æœ

#### 1. æ£€æŸ¥æ–‡ä»¶

```bash
# æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
ls -lh data/firmware/test-esp8266-001*

# æ£€æŸ¥æ–‡ä»¶ç±»å‹
file data/firmware/test-esp8266-001.ino
file data/firmware/test-esp8266-001_masked.bin
```

#### 2. éªŒè¯å›ºä»¶ä»£ç 

```bash
# æŸ¥çœ‹å›ºä»¶ä»£ç ï¼ˆå‰100è¡Œï¼‰
head -100 data/firmware/test-esp8266-001.ino

# æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®
grep -E "DEVICE_ID|mqtt_server|wifi" data/firmware/test-esp8266-001.ino
```

#### 3. éªŒè¯åŠ å¯†å›ºä»¶

```bash
# æ£€æŸ¥åŠ å¯†å›ºä»¶å¤§å°ï¼ˆåº”è¯¥æ¯”åŸå§‹å›ºä»¶ç•¥å¤§ï¼‰
ls -lh data/firmware/test-esp8266-001_masked.bin

# æ£€æŸ¥æ˜¯å¦ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶
file data/firmware/test-esp8266-001_masked.bin
```

### åç«¯æ—¥å¿—

æµ‹è¯•æ—¶ï¼ŒæŸ¥çœ‹åç«¯æ—¥å¿—ä»¥äº†è§£è¯¦ç»†è¿‡ç¨‹ï¼š

```bash
# å¦‚æœä½¿ç”¨uvicornç›´æ¥è¿è¡Œ
# æ—¥å¿—ä¼šæ˜¾ç¤ºåœ¨æ§åˆ¶å°

# æŸ¥çœ‹å…³é”®æ—¥å¿—
# [INFO] æ­£åœ¨å®‰è£…åº“: PubSubClient
# [INFO] åº“ PubSubClient å®‰è£…æˆåŠŸ
# [INFO] æ‰§è¡Œç¼–è¯‘å‘½ä»¤: arduino-cli compile ...
# [INFO] å›ºä»¶ç¼–è¯‘æˆåŠŸ: firmware.bin
# [INFO] åŠ å¯†å›ºä»¶: test-esp8266-001_masked.bin
```

### é«˜çº§ç”¨æ³•

#### 1. æµ‹è¯•ç‰¹å®šæ¨¡æ¿

ä¿®æ”¹è„šæœ¬ï¼ŒæŒ‡å®šæ¨¡æ¿IDï¼š
```python
template_id = "your-template-id"
build_result = await tester.build_encrypted_firmware(template_id)
```

#### 2. æµ‹è¯•OTAæ¨é€

å–æ¶ˆæ³¨é‡ŠOTAæ¨é€éƒ¨åˆ†ï¼š
```python
await tester.push_ota_update(firmware_build_id)
await tester.check_ota_status()
```

#### 3. æ‰¹é‡æµ‹è¯•

ä¿®æ”¹è„šæœ¬æ”¯æŒå¤šä¸ªè®¾å¤‡ï¼š
```python
DEVICE_IDS = ["device-001", "device-002", "device-003"]
for device_id in DEVICE_IDS:
    # æµ‹è¯•æ¯ä¸ªè®¾å¤‡
    ...
```

### æ€»ç»“

æµ‹è¯•è„šæœ¬éªŒè¯äº†ï¼š
- âœ… è¿œç¨‹åº“ç®¡ç†ï¼ˆArduino CLIï¼‰
- âœ… å›ºä»¶ä»£ç ç”Ÿæˆï¼ˆä»æ¨¡æ¿ï¼‰
- âœ… å›ºä»¶ç¼–è¯‘ï¼ˆArduino CLIï¼‰
- âœ… å›ºä»¶åŠ å¯†ï¼ˆXORæ©ç ï¼‰
- âœ… APIé›†æˆï¼ˆè®¤è¯ã€è®¾å¤‡ç®¡ç†ã€OTAï¼‰

æ‰€æœ‰åŠŸèƒ½éƒ½é€šè¿‡APIè°ƒç”¨å®Œæˆï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œæœ¬åœ°æ–‡ä»¶ã€‚

