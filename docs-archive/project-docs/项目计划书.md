# 基于MQTT与TLS的物联网设备安全管理与入侵检测系统
## 毕业设计项目计划书

---

## 一、项目背景与意义

### 1.1 研究背景

随着物联网技术的飞速发展，智能设备已广泛应用于工业控制、智能家居、智慧城市等领域。据预测，到2025年全球物联网设备连接数将超过750亿台。然而，物联网设备的安全性问题日益突出：

- **设备安全性薄弱**：大量IoT设备缺乏基本的安全防护，容易成为黑客攻击的目标
- **通信安全不足**：传统的明文传输易被窃听和篡改，造成数据泄露
- **缺乏统一管理**：设备分散、管理混乱，难以进行有效的安全监控
- **入侵检测困难**：传统安全机制难以适应IoT设备规模化和多样化的特点

因此，构建一个安全、可靠、易用的物联网设备安全管理平台具有重要的理论意义和实用价值。

### 1.2 国内外研究现状

**国外研究现状**：
- AWS IoT Core、Azure IoT Hub等云平台提供了设备管理能力
- Eclipse Mosquitto等开源MQTT Broker广泛应用
- TLS/SSL加密技术成熟，应用广泛

**国内研究现状**：
- 阿里云IoT、腾讯云IoT等平台发展迅速
- 国密算法（SM2/SM3/SM4）在IoT领域的应用正在推广
- 企业级IoT安全解决方案仍需完善

### 1.3 项目意义

**学术意义**：
- 将TLS加密技术应用于IoT设备通信安全
- 探索MQTT协议在设备管理中的应用
- 建立完整的入侵检测体系

**实用意义**：
- 提供开源的IoT安全管理解决方案
- 降低企业IoT部署门槛
- 提升IoT设备安全防护能力

---

## 二、系统整体架构

### 2.1 架构设计理念

本系统采用**分层架构设计**，从底层到顶层分为：基础设施层、接入安全层、传输安全层、应用安全层和零信任策略层，确保各层安全防护的完整性。

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      零信任策略层                             │
│         统一身份管理、动态授权、设备信任评分                   │
├─────────────────────────────────────────────────────────────┤
│                      应用安全层                               │
│        OAuth2/JWT、端到端加密、访问控制(RBAC)                 │
├─────────────────────────────────────────────────────────────┤
│                      传输安全层                               │
│        TLS 1.3、双向证书认证、消息加密                        │
├─────────────────────────────────────────────────────────────┤
│                      接入安全层                               │
│        一机一密、X.509证书、IP白名单、防重放                 │
├─────────────────────────────────────────────────────────────┤
│                      基础设施层                               │
│        MQTT Broker、数据库、缓存、容器化部署                  │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 技术架构

#### 2.3.1 总体架构

```
┌─────────────┐
│  设备层     │  ESP8266/ESP32物联网设备
└──────┬──────┘
       │ MQTT over TLS
       ↓
┌─────────────────────────────────┐
│  通信层     │  Mosquitto MQTT Broker
│             │  - TLS 1.3加密
│             │  - 双向证书认证
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────┐
│  应用层     │  FastAPI后端服务
│             │  └─ REST API (47个端点)
│             │  Vue3前端界面
│             │  └─ 设备管理、监控、安全
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────┐
│  存储层     │  PostgreSQL (关系型数据库)
│             │  Redis (缓存和会话)
│             │  时序数据存储
└─────────────────────────────────┘
```

#### 2.3.2 技术栈选型

| 层次 | 技术选型 | 说明 |
|------|---------|------|
| **设备端** | ESP8266/Arduino | 广泛应用的IoT芯片，成本低、功耗小 |
| **通信协议** | MQTT 3.1.1/5.0 | 轻量级、低带宽、适合IoT |
| **加密协议** | TLS 1.3 | 最新TLS版本，性能最优、安全性强 |
| **后端框架** | FastAPI (Python 3.11+) | 高性能、自动API文档、异步支持 |
| **前端框架** | Vue 3 + TypeScript | 渐进式框架、类型安全、生态丰富 |
| **数据库** | PostgreSQL 14+ | 功能强大、开源稳定、JSON支持 |
| **缓存** | Redis 7+ | 内存数据库、高性能、支持多种数据结构 |
| **消息队列** | Mosquitto MQTT | 轻量级、开源、高性能 |
| **容器化** | Docker + Compose | 环境隔离、快速部署、易于管理 |

---

## 三、核心功能模块

### 3.1 设备管理模块

**功能描述**：提供完整的IoT设备生命周期管理

**核心功能**：
- ✅ 设备注册与认证
  - 设备ID唯一性校验
  - 设备信息管理（名称、类型、描述）
  - 设备状态监控（在线/离线/维护中）
- ✅ 设备证书管理
  - CA证书自动生成
  - 设备证书签发与分发
  - 证书吊销与更新
  - 证书有效性验证
- ✅ 设备远程控制
  - 控制命令下发
  - 设备配置更新
  - 固件升级管理

**API端点**: `/api/v1/devices` (10个)

### 3.2 安全通信模块

**功能描述**：确保设备与服务器之间的通信安全

**核心功能**：
- ✅ TLS加密通信
  - TLS 1.3协议
  - 服务器证书管理
  - 客户端证书认证
  - 密码套件优化
- ✅ MQTT安全配置
  - ACL主题访问控制
  - 用户名密码认证
  - JWT令牌验证
  - 会话管理
- ✅ 证书管理系统
  - 自动生成CA、服务器、客户端证书
  - 证书CRL（吊销列表）
  - 证书到期提醒
  - 一键下载证书

**API端点**: `/api/v1/certificates` (6个)

### 3.3 入侵检测模块

**功能描述**：实时监控设备行为，识别异常和安全威胁

**核心功能**：
- ✅ 异常行为检测
  - 流量异常分析
  - 连接频率异常
  - 命令执行异常
  - 数据访问模式异常
- ✅ 安全事件记录
  - 自动记录安全事件
  - 事件分级（低/中/高/严重）
  - 事件关联分析
  - 安全审计日志
- ✅ 告警与响应
  - 实时告警推送
  - 告警规则配置
  - 自动响应机制
  - 告警处理记录

**API端点**: `/api/v1/security` (13个)

### 3.4 监控告警模块

**功能描述**：实时监控设备运行状态和系统资源

**核心功能**：
- ✅ 设备指标监控
  - CPU、内存、温度
  - 网络流量、延迟
  - 电池电量
  - 传感器数据
- ✅ 数据可视化
  - 实时数据曲线图
  - 历史数据查询
  - 统计图表展示
  - 数据导出功能
- ✅ 告警规则管理
  - 自定义告警阈值
  - 告警规则模板
  - 告警抑制与恢复
  - 告警通知配置

**API端点**: `/api/v1/monitoring` (9个)

### 3.5 用户管理模块

**功能描述**：系统用户和权限管理

**核心功能**：
- ✅ 用户认证
  - 用户名密码登录
  - JWT Token机制
  - Token刷新
  - 双因素认证（2FA）支持
- ✅ 权限管理
  - 基于角色的访问控制（RBAC）
  - 角色定义与分配
  - 权限细粒度控制
  - 操作审计

**API端点**: `/api/v1/users` (6个), `/api/v1/auth` (3个)

### 3.6 前端管理系统

**功能描述**：提供友好的Web管理界面

**核心功能**：
- ✅ 仪表盘
  - 设备概览统计
  - 实时状态监控
  - 告警统计
  - 快速操作入口
- ✅ 设备管理界面
  - 设备列表展示
  - 设备添加/编辑/删除
  - 设备详情查看
  - 证书管理
- ✅ 监控中心
  - 实时数据展示
  - 历史数据查询
  - 告警列表
  - 图表可视化
- ✅ 安全管理
  - 安全事件列表
  - 黑名单管理
  - 访问控制策略
  - 审计日志查询

**技术实现**: Vue 3 + Element Plus + ECharts

---

## 四、加密算法设计

### 4.1 传输层加密

#### 4.1.1 TLS 1.3协议

**算法选择**：
```
推荐密码套件（按优先级）：
1. TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
   - 密钥交换：ECDHE（椭圆曲线Diffie-Hellman）
   - 认证：ECDSA（椭圆曲线数字签名）
   - 对称加密：AES-256-GCM
   - 哈希算法：SHA-384

2. TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
   - 密钥交换：ECDHE
   - 认证：RSA
   - 对称加密：AES-256-GCM
   - 哈希算法：SHA-384

3. TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256
   - 现代化的流密码，在某些CPU上性能更优
```

**安全性特性**：
- ✅ **完美前向保密（PFS）**：每次会话使用临时密钥
- ✅ **0-RTT连接**：支持快速连接重试
- ✅ **加密握手**：握手过程本身加密
- ✅ **自动降级保护**：防止降级攻击

#### 4.1.2 X.509证书管理

**证书链结构**：
```
根CA证书 (Root CA)
    │
    ├── 签发服务器证书
    │   └── 用于MQTT Broker认证
    │
    └── 签发设备客户端证书
        └── 用于设备双向认证
```

**证书生成流程**：
1. 生成CA私钥和证书（自签名）
2. 服务器端：生成服务器私钥 → CSR签名请求 → CA签名 → 服务器证书
3. 设备端：生成客户端私钥 → CSR签名请求 → CA签名 → 客户端证书
4. 证书分发与安装

### 4.2 应用层加密

#### 4.2.1 密码存储

**算法**：bcrypt
```
特点：
- 自适应哈希算法
- 计算成本可调（工作因子）
- 内置盐值生成
- 防止彩虹表攻击

参数：
- 工作因子：12轮（推荐）
- 哈希长度：60字符
```

#### 4.2.2 JWT Token生成

**算法**：HMAC-SHA256 / RS256
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "exp": 1234567890,
    "iat": 1234567890,
    "is_admin": true
  },
  "signature": "HMACSHA256(base64UrlEncode(header) + '.' + base64UrlEncode(payload), secret)"
}
```

### 4.3 国密算法支持（扩展）

**未来规划**：支持国产密码算法

| 算法类型 | 国密算法 | 用途 |
|---------|---------|------|
| **对称加密** | SM4-GCM | 数据传输加密 |
| **非对称加密** | SM2 | 密钥交换、数字签名 |
| **哈希算法** | SM3 | 消息摘要 |
| **密码协议** | TLCP（国密SSL） | 双证书体系 |

---

## 五、数据库设计

### 5.1 核心数据表

#### 5.1.1 用户表（users）
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    is_admin BOOLEAN DEFAULT FALSE,
    totp_secret VARCHAR(32),
    failed_attempts INTEGER DEFAULT 0,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.1.2 设备表（devices）
```sql
CREATE TABLE devices (
    id UUID PRIMARY KEY,
    device_id VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'inactive',
    attributes JSONB,
    last_online_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.1.3 设备证书表（device_certificates）
```sql
CREATE TABLE device_certificates (
    id UUID PRIMARY KEY,
    device_id UUID REFERENCES devices(id) ON DELETE CASCADE,
    certificate TEXT NOT NULL,
    private_key TEXT,
    certificate_type VARCHAR(20) NOT NULL,
    serial_number VARCHAR(100) UNIQUE NOT NULL,
    issued_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    revoked_at TIMESTAMP,
    revoke_reason VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.1.4 安全事件表（security_events）
```sql
CREATE TABLE security_events (
    id UUID PRIMARY KEY,
    event_type VARCHAR(50) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    source_ip INET,
    device_id UUID REFERENCES devices(id) ON DELETE SET NULL,
    description TEXT NOT NULL,
    raw_data JSONB,
    handled BOOLEAN DEFAULT FALSE,
    handler_id UUID REFERENCES users(id),
    handled_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.1.5 监控指标表（device_metrics）
```sql
CREATE TABLE device_metrics (
    id VARCHAR PRIMARY KEY,
    device_id UUID REFERENCES devices(id) NOT NULL,
    metric_type VARCHAR NOT NULL,
    metrics JSONB NOT NULL,
    timestamp TIMESTAMP DEFAULT NOW()
);
```

#### 5.1.6 告警规则表（alert_rules）
```sql
CREATE TABLE alert_rules (
    id VARCHAR PRIMARY KEY,
    name VARCHAR NOT NULL,
    description TEXT,
    device_id UUID REFERENCES devices(id),
    metric_type VARCHAR NOT NULL,
    metric_name VARCHAR NOT NULL,
    condition VARCHAR NOT NULL,
    threshold FLOAT NOT NULL,
    severity VARCHAR NOT NULL,
    message VARCHAR NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 5.2 数据库关系图

```
users (用户)
    ├─ 1:N → roles (角色) [通过user_roles]
    └─ 1:N → security_events (安全事件处理)

devices (设备)
    ├─ 1:N → device_certificates (设备证书)
    ├─ 1:N → device_logs (设备日志)
    ├─ 1:N → device_metrics (监控指标)
    ├─ 1:N → monitoring_alerts (监控告警)
    ├─ 1:N → security_events (安全事件)
    └─ 1:N → access_control_policies (访问控制策略)
```

---

## 六、系统部署架构

### 6.1 Docker容器化部署

**docker-compose.yml**:
```yaml
services:
  postgres:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    environment:
      POSTGRES_DB: iot_security
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:latest
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data

  mosquitto:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"   # 非TLS端口
      - "8883:8883"   # TLS端口
      - "9001:9001"   # WebSocket
      - "9443:9443"   # TLS WebSocket
    volumes:
      - mosquitto_config:/mosquitto/config
      - mosquitto_data:/mosquitto/data
      - certs:/mosquitto/certs
```

### 6.2 部署拓扑

```
┌──────────────────────────────────────────────┐
│         Internet / 企业内网                    │
└──────────────────┬───────────────────────────┘
                   │
         ┌─────────▼─────────┐
         │  Nginx反向代理      │
         │  - SSL终端         │
         │  - 负载均衡         │
         └─────────┬─────────┘
                   │
      ┌────────────┼────────────┐
      │            │            │
┌─────▼─────┐ ┌───▼───┐ ┌──────▼────┐
│ FastAPI   │ │ Vue3  │ │ Mosquitto │
│ 后端服务   │ │前端   │ │MQTT Broker│
│ Port 8000 │ │5173   │ │ Port 8883 │
└─────┬─────┘ └───────┘ └──────┬────┘
      │                        │
      └────────┬───────────────┘
               │
      ┌────────▼────────┐
      │  PostgreSQL     │
      │  + Redis        │
      └─────────────────┘
```

---

## 七、开发计划与进度

### 7.1 开发阶段规划

| 阶段 | 时间 | 任务 | 状态 |
|------|------|------|------|
| **第一阶段：基础设施** | 2周 | MQTT配置、TLS证书、容器化部署 | ✅ 已完成 |
| **第二阶段：核心功能** | 4周 | 后端API、数据库、前端框架、设备端 | 🟡 进行中 |
| **第三阶段：安全功能** | 3周 | 入侵检测、告警系统、日志审计 | ⭕ 未开始 |
| **第四阶段：集成测试** | 2周 | 功能测试、性能测试、安全测试 | ⭕ 未开始 |
| **第五阶段：部署上线** | 1周 | 环境部署、监控配置、文档完善 | 🟡 部分完成 |

### 7.2 当前进度

**总体完成度：约 40-45%**

**已完成模块**：
- ✅ 用户认证授权（100%）
- ✅ TLS证书管理（100%）
- ✅ 设备管理后端（90%）
- ✅ 设备管理前端（40%）
- ✅ 通信安全配置（80%）
- ✅ 系统部署架构（80%）

**进行中模块**：
- 🟡 MQTT集成（70%）
- 🟡 监控告警框架（60%）
- 🟡 安全管理框架（60%）

**待完成模块**：
- ⭕ 入侵检测实现（20%）
- ⭕ 实时数据可视化（5%）
- ⭕ 设备端完整测试（50%）
- ⭕ 国密算法支持（0%）

---

## 八、创新点与技术难点

### 8.1 创新点

1. **多层次安全架构**：从底层传输到上层应用，构建完整的安全防护体系
2. **自动证书管理**：实现CA证书、服务器证书、设备证书的自动生成和分发
3. **轻量级入侵检测**：针对IoT设备特点，设计轻量级但高效的检测机制
4. **统一管理平台**：提供Web界面，实现设备、安全、监控的统一管理
5. **容器化部署**：采用Docker技术，实现一键部署和快速扩展

### 8.2 技术难点

1. **TLS证书在IoT设备中的应用**
   - 难点：ESP8266资源受限，如何高效处理TLS握手
   - 解决方案：使用轻量级TLS库，优化密码套件选择

2. **大规模设备并发管理**
   - 难点：支持千级设备同时在线，MQTT Broker性能优化
   - 解决方案：集群部署、负载均衡、消息队列缓存

3. **实时入侵检测**
   - 难点：低延迟检测异常行为，避免误报
   - 解决方案：基于规则的检测 + 机器学习分类

4. **端到端加密**
   - 难点：保证消息传输和存储的双重安全
   - 解决方案：TLS传输加密 + AES-GCM应用层加密

---

## 九、测试与验证

### 9.1 功能测试

**设备管理测试**：
- ✅ 设备注册/注销
- ✅ 设备证书生成与验证
- ✅ 设备状态查询
- ✅ 控制命令下发

**安全通信测试**：
- ✅ TLS握手成功率
- ✅ 证书验证机制
- ✅ 消息加密解密
- ✅ 断线重连机制

**入侵检测测试**：
- ✅ 异常流量检测
- ✅ 非法命令拦截
- ✅ 告警触发准确性
- ✅ 安全事件记录完整性

### 9.2 性能测试

**系统性能指标**：
- API响应时间：< 100ms
- 设备并发连接数：≥ 1000
- MQTT消息吞吐量：≥ 10000 msg/s
- 数据库查询性能：复杂查询 < 500ms

**压力测试**：
- 模拟1000个设备同时在线
- 每设备每10秒发送1条消息
- 持续运行24小时，记录系统稳定性

### 9.3 安全测试

**渗透测试**：
- SQL注入攻击防护
- XSS跨站脚本攻击防护
- CSRF跨站请求伪造防护
- 中间人攻击（MITM）防护

**加密强度测试**：
- TLS 1.3密码套件强度验证
- bcrypt哈希算法性能评估
- JWT Token安全性分析

---

## 十、预期成果

### 10.1 系统交付物

1. **源代码**
   - 后端服务代码（Python）
   - 前端界面代码（Vue 3）
   - 设备端固件（Arduino）
   - Docker配置文件

2. **技术文档**
   - 系统需求分析文档
   - 系统架构设计文档
   - 数据库设计文档
   - API接口文档
   - 用户操作手册

3. **测试报告**
   - 功能测试报告
   - 性能测试报告
   - 安全测试报告

### 10.2 技术创新点

1. **证书自动管理**：开发了完整的X.509证书管理系统，支持一键生成和分发
2. **IoT安全框架**：构建了针对IoT场景的分层安全架构
3. **开源贡献**：提供开源方案，降低企业IoT部署成本

### 10.3 应用前景

**工业领域**：
- 智能制造设备管理
- 工业物联网安全监控
- 设备预测性维护

**智慧城市**：
- 智能交通系统
- 环境监测网络
- 公共设施管理

**智能家居**：
- 家庭设备统一管理
- 隐私数据保护
- 远程控制安全

---

## 十一、参考文献

1. MQTT协议规范 - OASIS标准, v3.1.1/v5.0
2. TLS 1.3规范 - RFC 8446
3. X.509公钥证书格式 - RFC 5280
4. IoT安全最佳实践 - OWASP IoT Top 10
5. 国密算法标准 - GM/T系列标准文档

---

## 十二、项目总结

本项目构建了一个**基于MQTT与TLS的物联网设备安全管理与入侵检测系统**，实现了以下目标：

✅ **安全性**：多层次安全架构，TLS加密通信，自动证书管理  
✅ **可用性**：Web管理界面，设备状态监控，实时告警  
✅ **可扩展性**：容器化部署，水平扩展，插件化架构  
✅ **可维护性**：完整文档，清晰代码，标准化接口  

**当前进展**：
- 总体完成度：**40-45%**
- 核心框架：**已完成**
- 关键功能：**部分实现**
- 预期完成：**按计划推进**

**下一步计划**：
1. 完善入侵检测算法
2. 实现数据可视化
3. 优化系统性能
4. 进行综合测试

---

**项目作者**：shigure(龙勇君—22016021241)

---

**附录**：
- A. 项目源代码仓库：[]
- B. 在线演示地址：[待部署]
- C. API文档地址：http://localhost:8000/docs
- D. 更多详细文档见 `docs/` 目录