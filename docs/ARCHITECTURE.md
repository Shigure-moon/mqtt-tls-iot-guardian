# 系统架构设计文档

## 一、系统整体架构

### 1.1 安全分层架构
```
┌──────────────┐
│ 零信任策略层 │  统一身份管理、动态授权、设备信任评分
├──────────────┤
│ 应用安全层   │  OAuth2/JWT、国密SM2/SM4、端到端加密
├──────────────┤
│ 传输安全层   │  TLS 1.3 + 国密SSL、双向证书认证
├──────────────┤
│ 接入安全层   │  一机一密、X.509、IP白名单、防重放
├──────────────┤
│ 基础设施层   │  VLAN隔离、KMS、容器化部署、自动化运维
└──────────────┘
```

### 1.2 部署架构
```
Internet Zone
    │
    ├── WAF/IPS ── 边界防火墙
    │
DMZ Zone
    ├── Nginx 反向代理（SSL终端）
    │   └── Let's Encrypt 自动证书
    │
安全区
    ├── MQTT Broker 集群
    │   ├── Mosquitto 节点1 (Master)
    │   ├── Mosquitto 节点2 (Master)
    │   └── Mosquitto 节点3 (Arbiter)
    │
    ├── 应用服务集群
    │   ├── FastAPI 后端服务
    │   ├── Vue3 前端服务
    │   └── 设备管理服务
    │
    ├── 数据服务集群
    │   ├── PostgreSQL (主)
    │   ├── PostgreSQL (从)
    │   └── Redis 集群
    │
    └── 安全审计系统
        ├── 日志采集
        ├── 入侵检测
        └── 安全分析
```

## 二、核心组件设计

### 2.1 MQTT安全组件
- TLS 1.3 + 国密SSL双证书
- 基于X.509的设备认证
- ACL主题级访问控制
- JWT令牌认证
- 消息加密与签名

### 2.2 后端服务组件
- FastAPI REST API服务
- MQTT Bridge服务
- 设备管理服务
- 入侵检测服务
- 日志审计服务

### 2.3 前端组件
- Vue3 SPA应用
- Element Plus UI框架
- ECharts数据可视化
- WebSocket实时通讯

### 2.4 存储组件
- PostgreSQL主从复制
- Redis集群缓存
- 时序数据库
- 对象存储

## 三、安全架构

### 3.1 设备接入安全
- 一机一密的设备认证
- 基于证书的双向认证
- 动态密钥轮换
- 设备指纹识别

### 3.2 通信安全
```
Device ←→ MQTT Broker
  │        │
  └────────┴─→ TLS 1.3
  │        │
  └────────┴─→ 国密SSL
  │        │
  └────────┴─→ JWT Token
```

### 3.3 数据安全
- 端到端加密
- 数据脱敏
- 加密存储
- 安全审计

### 3.4 运维安全
- 容器化部署
- 自动化运维
- 监控告警
- 灾备恢复

## 四、技术栈选型

### 4.1 后端技术栈
- Python 3.11+
- FastAPI
- SQLAlchemy
- Paho-MQTT
- Celery

### 4.2 前端技术栈
- Vue 3
- TypeScript
- Element Plus
- ECharts
- Vite

### 4.3 数据库
- PostgreSQL 14+
- Redis 7+
- InfluxDB

### 4.4 运维工具
- Docker
- Docker Compose
- Nginx
- Prometheus + Grafana

## 五、系统性能指标

### 5.1 并发性能
- MQTT连接数：10000+
- 消息吞吐量：10000+ msg/s
- API响应时间：<100ms
- 页面加载时间：<3s

### 5.2 可用性指标
- 系统可用性：99.9%
- 数据可靠性：99.99%
- 故障恢复时间：<5min

### 5.3 安全指标
- 密钥轮换周期：30天
- 证书有效期：1年
- 审计日志保存：180天
- 入侵检测响应：<1s

## 六、灾备方案

### 6.1 数据备份
- 数据库定时备份
- 配置文件版本控制
- 证书安全存储

### 6.2 故障转移
- 服务自动重启
- 负载均衡
- 主从切换

### 6.3 监控告警
- 资源监控
- 性能监控
- 安全监控
- 业务监控